<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forja de Atributos. - Sistema de Gestão de Tags</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/unrar-js@0.2.2/lib/unrar.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 700; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-card { transition: all 0.2s ease; border-left: 4px solid transparent; }
        .file-card:hover { transform: translateY(-2px); border-color: #3b82f6; border-left-width: 4px; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; align-items: center; justify-content: center; flex-direction: column; }
        .tag-path { font-family: 'Courier New', Courier, monospace; font-size: 10px; color: #94a3b8; word-break: break-all; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="loading" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
        <p id="loading-text" class="text-blue-600 font-bold">Processando arquivos...</p>
    </div>

    <!-- Cabeçalho Simplificado -->
    <nav class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-10 shadow-sm">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg shadow-blue-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-slate-800 leading-none">Forja de <span class="text-blue-600">Atributos.</span></h1>
                </div>
            </div>
            <div id="engine-status" class="hidden"></div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 space-y-6">
            <section class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                <div class="flex border-b border-slate-100 bg-slate-50/50">
                    <button onclick="switchTab('tab-upload')" id="btn-tab-upload" class="flex-1 py-4 text-[10px] font-black uppercase tracking-tighter text-slate-400 tab-active">1. Importar</button>
                    <button onclick="switchTab('tab-cadastro')" id="btn-tab-cadastro" class="flex-1 py-4 text-[10px] font-black uppercase tracking-tighter text-slate-400">2. Dados</button>
                    <button onclick="switchTab('tab-tags')" id="btn-tab-tags" class="flex-1 py-4 text-[10px] font-black uppercase tracking-tighter text-slate-400">3. Tag</button>
                    <button onclick="switchTab('tab-gerador')" id="btn-tab-gerador" class="flex-1 py-4 text-[10px] font-black uppercase tracking-tighter text-slate-400">4. Exportar</button>
                </div>

                <div class="p-8">
                    <div id="tab-upload" class="tab-content active space-y-5">
                        <div id="drop-zone" class="group border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center hover:border-blue-400 hover:bg-blue-50/30 cursor-pointer transition-all duration-300">
                            <input type="file" id="file-input" class="hidden" accept=".xml,.zip,.rar" multiple>
                            <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 group-hover:bg-blue-100 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                            </div>
                            <p class="text-sm text-slate-600 font-bold">Arraste seus arquivos aqui</p>
                        </div>
                    </div>

                    <div id="tab-cadastro" class="tab-content space-y-6">
                        <div class="p-4 bg-blue-600 rounded-2xl shadow-lg">
                            <label class="block text-[9px] font-black text-blue-100 uppercase mb-2">Selecionar do Lote:</label>
                            <select id="batch-selector" onchange="loadFromBatch(this.value)" class="w-full bg-white border-none rounded-xl px-4 py-3 text-sm text-blue-900 font-bold focus:ring-2 focus:ring-blue-400 outline-none"></select>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1 tracking-widest">Chave de Acesso</label>
                                <input type="text" id="input-chave" readonly class="w-full bg-transparent border-none p-0 text-[11px] font-mono font-bold text-slate-600">
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1 tracking-widest">Embarcador / Remetente</label>
                                <input type="text" id="input-remetente" readonly class="w-full bg-transparent border-none p-0 text-sm font-bold text-slate-800">
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1 tracking-widest">Transportadora / Emitente</label>
                                <input type="text" id="input-emitente" readonly class="w-full bg-transparent border-none p-0 text-sm font-bold text-slate-800">
                            </div>
                        </div>
                    </div>

                    <div id="tab-tags" class="tab-content space-y-4">
                        <div id="quick-results" class="space-y-4">
                            <div class="text-center py-10">
                                <p class="text-sm text-slate-400">Selecione um arquivo para ver as tags.</p>
                            </div>
                        </div>
                    </div>

                    <div id="tab-gerador" class="tab-content space-y-4 text-center">
                        <button onclick="exportToExcel()" class="w-full bg-emerald-600 text-white px-6 py-4 rounded-2xl hover:bg-emerald-700 shadow-lg font-black text-xs uppercase tracking-widest">Baixar CSV do Lote</button>
                        <button onclick="resetApp()" class="w-full text-xs font-bold text-slate-400 hover:text-red-500 transition-colors uppercase py-2">Limpar Tudo</button>
                    </div>
                </div>
            </section>
        </div>

        <div class="lg:col-span-8">
            <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden flex flex-col h-[650px]">
                <div class="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Explorador de Lote</h2>
                    <div id="status-badge" class="px-3 py-1 bg-white border border-slate-200 rounded-full text-[10px] font-black text-slate-400 uppercase">Vazio</div>
                </div>
                <div class="flex-1 overflow-auto p-8 bg-slate-50/30">
                    <div id="batch-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-300">
                        <p class="font-bold uppercase text-xs tracking-widest">Nenhum arquivo processado</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let batchData = [];
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const batchSelector = document.getElementById('batch-selector');
        const batchGrid = document.getElementById('batch-grid');
        const statusBadge = document.getElementById('status-badge');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('[id^="btn-tab-"]').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('tab-active');
        }

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-400', 'bg-blue-50/30'); };
        dropZone.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
        fileInput.onchange = (e) => { if (e.target.files.length > 0) handleFiles(e.target.files); };

        async function handleFiles(files) {
            loading.style.display = 'flex';
            for (const file of Array.from(files)) {
                const ext = file.name.split('.').pop().toLowerCase();
                try {
                    if (ext === 'zip') await processZip(file);
                    else if (ext === 'rar') await processRar(file);
                    else if (ext === 'xml') await processXml(file);
                } catch (e) { console.error(e); }
            }
            renderUI();
            loading.style.display = 'none';
        }

        async function processRar(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const buffer = new Uint8Array(e.target.result);
                        const extractor = unrar.createExtractorFromData(buffer);
                        const list = extractor.getFileList();
                        if (list && list.state === "SUCCESS") {
                            for (const header of list.arcHeader.fileHeaders) {
                                if (header.name.toLowerCase().endsWith('.xml')) {
                                    const extracted = extractor.extractFiles([header.name]);
                                    if (extracted.state === "SUCCESS") {
                                        const text = new TextDecoder("utf-8").decode(extracted.files[0].extraction);
                                        const xmlDoc = new DOMParser().parseFromString(text, "text/xml");
                                        batchData.push(parseXML(header.name.split('/').pop(), xmlDoc));
                                    }
                                }
                            }
                        }
                    } catch (err) { console.error(err); }
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function processZip(file) {
            const zip = new JSZip();
            const content = await zip.loadAsync(file);
            for (const path of Object.keys(content.files)) {
                if (path.toLowerCase().endsWith('.xml')) {
                    const text = await content.files[path].async("string");
                    const xmlDoc = new DOMParser().parseFromString(text, "text/xml");
                    batchData.push(parseXML(path.split('/').pop(), xmlDoc));
                }
            }
        }

        async function processXml(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const xmlDoc = new DOMParser().parseFromString(e.target.result, "text/xml");
                    batchData.push(parseXML(file.name, xmlDoc));
                    resolve();
                };
                reader.readAsText(file);
            });
        }

        function parseXML(filename, xml) {
            const getTagValue = (tagName) => {
                const elements = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", tagName) : xml.getElementsByTagName(tagName);
                return elements.length > 0 ? elements[0].textContent : "N/A";
            };

            const findObsContValue = (campoNome) => {
                const tagsParaTentar = ["obsCont", "ObsCont"];
                for (let tag of tagsParaTentar) {
                    const obsConts = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", tag) : xml.getElementsByTagName(tag);
                    for (let i = 0; i < obsConts.length; i++) {
                        if (obsConts[i].getAttribute("xCampo") === campoNome) {
                            const xTextos = obsConts[i].getElementsByTagNameNS ? obsConts[i].getElementsByTagNameNS("*", "xTexto") : obsConts[i].getElementsByTagName("xTexto");
                            return xTextos.length > 0 ? xTextos[0].textContent : "N/A";
                        }
                    }
                }
                return "N/A";
            };

            const infCteElements = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", "infCte") : xml.getElementsByTagName("infCte");
            const infNFeElements = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", "infNFe") : xml.getElementsByTagName("infNFe");
            
            const infCte = infCteElements[0];
            const infNFe = infNFeElements[0];
            
            let chave = (infCte?.getAttribute("Id") || infNFe?.getAttribute("Id") || "").replace(/\D/g, '');

            const remElements = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", "rem") : xml.getElementsByTagName("rem");
            const rem = remElements[0];
            const remNome = rem ? (rem.getElementsByTagNameNS ? rem.getElementsByTagNameNS("*", "xNome")[0]?.textContent : rem.getElementsByTagName("xNome")[0]?.textContent) || "N/A" : "N/A";

            const emitElements = xml.getElementsByTagNameNS ? xml.getElementsByTagNameNS("*", "emit") : xml.getElementsByTagName("emit");
            const emit = emitElements[0];
            const emitNome = emit ? (emit.getElementsByTagNameNS ? emit.getElementsByTagNameNS("*", "xNome")[0]?.textContent : emit.getElementsByTagName("xNome")[0]?.textContent) || "N/A" : "N/A";

            return {
                filename,
                chave,
                remNome,
                emitNome,
                results: [
                    { label: "Número CTe", value: getTagValue("nCT"), path: "cteProc/CTe/infCte/ide/nCT" },
                    { label: "Origem", value: getTagValue("xMunIni"), path: "cteProc/CTe/infCte/ide/xMunIni" },
                    { label: "Destino", value: getTagValue("xMunFim"), path: "cteProc/CTe/infCte/ide/xMunFim" },
                    { label: "Tipo de Veiculo", value: findObsContValue("TipoVeiculo"), path: "cteProc/CTe/infCte/compl/ObsCont?xCampo=TipoVeiculo" },
                    { label: "Operação", value: findObsContValue("TipoOperacao"), path: "cteProc/CTe/infCte/compl/ObsCont?xCampo=TipoOperacao" }
                ]
            };
        }

        function copyTagPath(path) {
            const el = document.createElement('textarea');
            el.value = path;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }

        function loadFromBatch(index) {
            const data = batchData[index];
            if (!data) return;
            
            batchSelector.value = index;
            document.getElementById('input-chave').value = data.chave;
            document.getElementById('input-remetente').value = data.remNome;
            document.getElementById('input-emitente').value = data.emitNome;

            const container = document.getElementById('quick-results');
            container.innerHTML = '';
            
            data.results.forEach(res => {
                const div = document.createElement('div');
                div.className = "p-5 bg-slate-50 border border-slate-100 rounded-3xl space-y-2 group hover:bg-white transition-all shadow-sm";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${res.label}</span>
                        <span class="text-sm font-black text-slate-800">${res.value}</span>
                    </div>
                    <div class="pt-2 border-t border-slate-100 flex flex-col gap-2">
                        <span class="tag-path">${res.path}</span>
                        <button onclick="copyTagPath('${res.path}')" class="flex items-center gap-1 text-[9px] font-bold text-blue-600 uppercase tracking-tighter self-start">
                            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            Copiar Caminho
                        </button>
                    </div>`;
                container.appendChild(div);
            });
        }

        function renderUI() {
            batchSelector.innerHTML = '';
            batchGrid.innerHTML = '';
            if (batchData.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            emptyState.style.display = 'none';
            batchData.forEach((item, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.textContent = item.filename;
                batchSelector.appendChild(opt);
                const card = document.createElement('div');
                card.className = "file-card p-5 bg-white border border-slate-200 rounded-3xl cursor-pointer hover:shadow-lg transition-all";
                card.onclick = () => { loadFromBatch(i); switchTab('tab-cadastro'); };
                card.innerHTML = `<h3 class="text-xs font-black text-slate-800 truncate mb-1">${item.filename}</h3>
                                  <p class="text-[9px] text-blue-500 font-bold truncate uppercase">Emit: ${item.emitNome}</p>
                                  <p class="text-[9px] text-slate-400 font-bold truncate uppercase">Rem: ${item.remNome}</p>`;
                batchGrid.appendChild(card);
            });
            statusBadge.innerText = `${batchData.length} XMLs`;
            loadFromBatch(0);
        }

        function exportToExcel() {
            if (batchData.length === 0) return;
            // Atualizado para incluir o Número do CTe no CSV
            let csv = "\uFEFFArquivo;CTe_Numero;Chave;Embarcador;Transportadora;Origem;Destino;TipoVeiculo;Operação\n";
            batchData.forEach(d => {
                csv += `"${d.filename}";"${d.results[0].value}";"${d.chave}";"${d.remNome}";"${d.emitNome}";"${d.results[1].value}";"${d.results[2].value}";"${d.results[3].value}";"${d.results[4].value}"\n`;
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "relatorio_lote.csv";
            link.click();
        }

        function resetApp() { if(confirm("Limpar lote?")) location.reload(); }
    </script>
</body>
</html>
