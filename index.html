<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forja Atributo - Cloud Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; background-color: #f8fafc; }
        
        .tab-content { display: none; height: 100%; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .sidebar-item { transition: all 0.3s; cursor: pointer; border-left: 4px solid transparent; margin: 4px 12px; border-radius: 8px; color: #94a3b8; }
        .sidebar-item.tab-active { background-color: rgba(255, 255, 255, 0.1); color: white; border-left-color: #3b82f6; }
        
        .tag-card { border: 1px solid #e2e8f0; background: white; border-radius: 16px; padding: 1.25rem; display: flex; flex-direction: column; gap: 0.5rem; cursor: pointer; transition: transform 0.2s; }
        .tag-card:hover { transform: translateY(-2px); border-color: #3b82f6; }

        .loading-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9000; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; }
        .sidebar-hidden { width: 0 !important; overflow: hidden; opacity: 0; }

        .badge-dynamic { font-size: 9px; padding: 2px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; }
        
        #side-list::-webkit-scrollbar { width: 4px; }
        #side-list::-webkit-scrollbar-track { background: transparent; }
        #side-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900 h-screen flex">

    <div id="loading-overlay" class="loading-overlay">
        <div class="text-5xl animate-bounce mb-4">‚öôÔ∏è</div>
        <h2 class="text-xl font-black uppercase tracking-widest">Processando Lote</h2>
        <p id="loading-stats" class="text-blue-400 font-mono mt-2">0%</p>
    </div>

    <aside class="w-64 bg-[#0f172a] flex flex-col shrink-0">
        <div class="p-6 mb-4 flex items-center gap-3 border-b border-slate-800">
            <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center text-white font-black text-xl">F</div>
            <h1 class="text-lg font-black text-white uppercase tracking-tighter">FORJA <span class="text-blue-500">PRO</span></h1>
        </div>
        <nav class="flex-1">
            <div onclick="switchTab('tab-upload')" id="btn-tab-upload" class="sidebar-item px-5 py-3 flex items-center gap-3 text-sm font-bold">Upload</div>
            <div onclick="switchTab('tab-tags')" id="btn-tab-tags" class="sidebar-item px-5 py-3 flex items-center gap-3 text-sm font-bold tab-active">Visualizar Lote</div>
            <div onclick="switchTab('tab-info-xml')" id="btn-tab-info-xml" class="sidebar-item px-5 py-3 flex items-center gap-3 text-sm font-bold">Detalhamento</div>
            <div onclick="switchTab('tab-gerador')" id="btn-tab-gerador" class="sidebar-item px-5 py-3 flex items-center gap-3 text-sm font-bold">Exportar</div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8">
            <div class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Mapeamento de Atributos CTe</div>
            <div id="status-badge" class="bg-blue-600 text-white text-[10px] font-black px-4 py-1.5 rounded-full uppercase">Pronto</div>
        </header>

        <div class="flex-1 overflow-hidden flex">
            <div class="flex-1 overflow-auto p-6">
                
                <div id="tab-upload" class="tab-content items-center justify-center">
                    <div id="drop-zone" class="w-full max-w-lg border-2 border-dashed border-slate-300 rounded-[2.5rem] p-20 text-center bg-white hover:border-blue-500 cursor-pointer transition-all shadow-sm">
                        <input type="file" id="file-input" class="hidden" accept=".xml,.zip" multiple>
                        <div class="text-6xl mb-6">üìÇ</div>
                        <h3 class="text-xl font-black text-slate-800">Importar XMLs</h3>
                        <p class="text-slate-400 text-sm mt-2">Clique ou arraste arquivos aqui.</p>
                    </div>
                </div>

                <div id="tab-tags" class="tab-content active">
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm mb-6 flex gap-4">
                        <input type="text" id="global-search" oninput="renderTags()" placeholder="Filtrar por nCT, Chave, Ve√≠culo, Opera√ß√£o ou Cobran√ßa..." class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20">
                        <button onclick="data = []; renderTags(); renderSideList(); document.getElementById('batch-sidebar').classList.add('sidebar-hidden');" class="px-4 text-xs font-bold text-red-500 hover:bg-red-50 rounded-xl transition-colors">Limpar Lote</button>
                    </div>
                    <div id="tags-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-10"></div>
                </div>

                <div id="tab-info-xml" class="tab-content">
                    <div id="info-container" class="hidden space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-blue-500">
                                <span class="text-[10px] font-black text-blue-500 uppercase">Tipo de Opera√ß√£o</span>
                                <p id="d-operacao" class="font-bold text-slate-800 text-lg mt-1">---</p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500">
                                <span class="text-[10px] font-black text-purple-500 uppercase">Tipo de Ve√≠culo</span>
                                <p id="d-veiculo" class="font-bold text-slate-800 text-lg mt-1">---</p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-orange-500">
                                <span class="text-[10px] font-black text-orange-500 uppercase">Tipo de Cobran√ßa</span>
                                <p id="d-cobranca" class="font-bold text-slate-800 text-lg mt-1">---</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Origem / Destino</span>
                                <p class="font-bold text-slate-800 text-md mt-1">
                                    <span id="d-origem">---</span> <span class="text-slate-300 mx-2">‚Üí</span> <span id="d-destino">---</span>
                                </p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                <span class="text-[10px] font-black text-slate-400 uppercase">Caracter√≠stica Adicional</span>
                                <p id="d-carac" class="font-bold text-slate-800 text-md mt-1">---</p>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">Atributos Extra√≠dos (ObsCont)</h3>
                            <div id="d-attributes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-gerador" class="tab-content items-center justify-center">
                    <div class="text-center">
                        <div class="w-24 h-24 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-6">üíæ</div>
                        <h2 class="text-2xl font-black text-slate-800 mb-2">Exportar Mapeamento</h2>
                        <button onclick="exportCSV()" class="bg-slate-900 text-white px-12 py-4 rounded-2xl font-black uppercase text-sm shadow-xl hover:bg-black transition-all mt-4">Download CSV</button>
                    </div>
                </div>
            </div>

            <div id="batch-sidebar" class="w-80 bg-white border-l border-slate-200 sidebar-hidden transition-all duration-300">
                <div class="p-5 border-b bg-slate-50">
                    <span class="text-[10px] font-black uppercase text-slate-400">Ficheiros no Lote</span>
                </div>
                <div id="side-list" class="p-4 space-y-3 overflow-auto h-[calc(100vh-100px)]"></div>
            </div>
        </div>
    </main>

    <script>
        let data = [];
        let selectedIdx = -1;

        async function handleFiles(files) {
            document.getElementById('loading-overlay').style.display = 'flex';
            const list = Array.from(files);
            
            for (let i = 0; i < list.length; i++) {
                const f = list[i];
                try {
                    if (f.name.toLowerCase().endsWith('.xml')) {
                        const text = await f.text();
                        parse(f.name, text);
                    } else if (f.name.toLowerCase().endsWith('.zip')) {
                        const zip = await JSZip.loadAsync(f);
                        const zipFiles = Object.keys(zip.files).filter(name => name.toLowerCase().endsWith('.xml'));
                        for (let zName of zipFiles) {
                            const text = await zip.files[zName].async("text");
                            parse(zName.split('/').pop(), text);
                        }
                    }
                } catch (err) {
                    console.error("Erro no arquivo:", f.name, err);
                }
                document.getElementById('loading-stats').innerText = Math.round(((i+1)/list.length)*100) + '%';
            }

            renderTags();
            renderSideList();
            document.getElementById('batch-sidebar').classList.remove('sidebar-hidden');
            document.getElementById('status-badge').innerText = `${data.length} XMLs Processados`;
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function parse(filename, text) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            
            // Helper robusto para pegar valor de tag ignorando namespace
            const getVal = (parent, tagName) => {
                const el = parent ? parent.getElementsByTagNameNS("*", tagName)[0] : xml.getElementsByTagNameNS("*", tagName)[0];
                return el ? el.textContent.trim() : null;
            };

            // Localizar infCte
            const infCte = xml.getElementsByTagNameNS("*", "infCte")[0];
            if (!infCte) return;

            const ide = infCte.getElementsByTagNameNS("*", "ide")[0];
            const compl = infCte.getElementsByTagNameNS("*", "compl")[0];

            const nCT = getVal(ide, "nCT");
            const chave = infCte.getAttribute("Id")?.replace("CTe", "") || "";
            
            // Origem e Destino conforme solicitado
            const origem = getVal(ide, "xMunIni");
            const destino = getVal(ide, "xMunFim");
            
            // Caracter√≠stica Adicional (xCaracAd)
            const caracAd = compl ? getVal(compl, "xCaracAd") : null;

            let camposDinamicos = {};
            if (compl) {
                const obsConts = compl.getElementsByTagNameNS("*", "obsCont");
                for (let i = 0; i < obsConts.length; i++) {
                    const node = obsConts[i];
                    const campo = node.getAttribute("xCampo");
                    const textoEl = node.getElementsByTagNameNS("*", "xTexto")[0];
                    if (campo && textoEl) {
                        camposDinamicos[campo] = textoEl.textContent.trim();
                    }
                }
            }

            // Fun√ß√£o para busca insens√≠vel de chaves nos campos din√¢micos
            const findKey = (obj, target) => {
                const key = Object.keys(obj).find(k => k.toLowerCase() === target.toLowerCase());
                return key ? obj[key] : "N/A";
            };

            data.push({
                filename,
                nCT,
                chave,
                origem,
                destino,
                caracteristicasAdicionais: caracAd,
                tipoOperacao: findKey(camposDinamicos, "TipoOperacao"),
                tipoVeiculo: findKey(camposDinamicos, "TipoVeiculo"),
                tipoCobranca: findKey(camposDinamicos, "TipoCobranca"),
                camposDinamicos
            });
        }

        function renderTags() {
            const grid = document.getElementById('tags-grid');
            const search = document.getElementById('global-search').value.toLowerCase();
            
            const filtered = data.filter(d => 
                (d.nCT && d.nCT.includes(search)) || 
                (d.chave && d.chave.includes(search)) ||
                (d.origem && d.origem.toLowerCase().includes(search)) ||
                (d.destino && d.destino.toLowerCase().includes(search)) ||
                (d.tipoVeiculo && d.tipoVeiculo.toLowerCase().includes(search)) ||
                (d.tipoOperacao && d.tipoOperacao.toLowerCase().includes(search)) ||
                (d.tipoCobranca && d.tipoCobranca.toLowerCase().includes(search))
            );

            grid.innerHTML = filtered.length ? '' : '<div class="col-span-full text-center py-20 text-slate-400 font-bold">Nenhum resultado encontrado.</div>';
            
            filtered.forEach((d) => {
                const globalIdx = data.indexOf(d);
                const div = document.createElement('div');
                div.className = "tag-card";
                div.onclick = () => select(globalIdx);
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">nCT ${d.nCT || 'N/A'}</span>
                        <div class="flex gap-1">
                            ${d.tipoOperacao !== 'N/A' ? `<span class="badge-dynamic bg-blue-100 text-blue-600">${d.tipoOperacao}</span>` : ''}
                            ${d.tipoVeiculo !== 'N/A' ? `<span class="badge-dynamic bg-purple-100 text-purple-600">${d.tipoVeiculo}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="font-bold text-slate-800">${d.origem || '---'}</span>
                        <span class="text-slate-300">‚Üí</span>
                        <span class="font-bold text-slate-800">${d.destino || '---'}</span>
                    </div>
                    <div class="text-[9px] text-slate-500 font-medium mt-1">
                        Cobran√ßa: <span class="text-slate-800 font-bold">${d.tipoCobranca}</span>
                    </div>
                    <p class="text-[10px] text-blue-500 font-mono mt-2 truncate">${d.chave}</p>
                `;
                grid.appendChild(div);
            });
        }

        function select(i) {
            selectedIdx = i;
            const d = data[i];
            if (!d) return;

            renderSideList();
            document.getElementById('info-container').classList.remove('hidden');
            
            document.getElementById('d-operacao').innerText = d.tipoOperacao;
            document.getElementById('d-veiculo').innerText = d.tipoVeiculo;
            document.getElementById('d-cobranca').innerText = d.tipoCobranca;
            document.getElementById('d-origem').innerText = d.origem || '---';
            document.getElementById('d-destino').innerText = d.destino || '---';
            document.getElementById('d-carac').innerText = d.caracteristicasAdicionais || 'null';
            
            const attrDiv = document.getElementById('d-attributes');
            const entries = Object.entries(d.camposDinamicos);
            
            attrDiv.innerHTML = entries.length > 0 
                ? entries.map(([k, v]) => `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">${k}</p>
                        <p class="text-xs font-bold text-slate-700 mt-1">${v}</p>
                    </div>
                `).join('')
                : '<p class="col-span-full text-slate-400 text-xs italic text-center py-4">Nenhuma observa√ß√£o din√¢mica (ObsCont) encontrada.</p>';
            
            switchTab('tab-info-xml');
        }

        function renderSideList() {
            const list = document.getElementById('side-list');
            list.innerHTML = '';
            data.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl border-2 cursor-pointer transition-all ${i === selectedIdx ? 'border-blue-500 bg-blue-50' : 'border-slate-50 bg-white hover:border-slate-200'}`;
                div.onclick = () => select(i);
                div.innerHTML = `
                    <p class="text-xs font-bold truncate">${f.filename}</p>
                    <p class="text-[9px] text-slate-400 uppercase font-black mt-1">N¬∫ ${f.nCT || '?'} | ${f.tipoVeiculo}</p>
                `;
                list.appendChild(div);
            });
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('tab-active'));
            const content = document.getElementById(id);
            const btn = document.getElementById('btn-' + id);
            if(content) content.classList.add('active');
            if(btn) btn.classList.add('tab-active');
        }

        function exportCSV() {
            if (data.length === 0) return;
            const dynamicHeaders = [...new Set(data.flatMap(d => Object.keys(d.camposDinamicos)))];
            const headers = ["Arquivo", "nCT", "Chave", "Origem", "Destino", "CaracAdicional", ...dynamicHeaders];
            let csvRows = [headers.join(";")];
            data.forEach(d => {
                const row = [
                    d.filename, d.nCT, d.chave, d.origem, d.destino, d.caracteristicasAdicionais || "null",
                    ...dynamicHeaders.map(h => d.camposDinamicos[h] || "")
                ];
                csvRows.push(row.join(";"));
            });
            const blob = new Blob(["\ufeff" + csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `mapeamento_cte_${new Date().getTime()}.csv`;
            link.click();
        }

        document.getElementById('drop-zone').onclick = () => document.getElementById('file-input').click();
        document.getElementById('file-input').onchange = (e) => handleFiles(e.target.files);
    </script>
</body>
</html>
